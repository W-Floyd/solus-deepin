From b50c9e4004833e3c0034b68b4082d6e590510949 Mon Sep 17 00:00:00 2001
From: Kevin Albertson <kevin.albertson@10gen.com>
Date: Tue, 18 Sep 2018 12:22:29 -0400
Subject: [PATCH] CDRIVER-2827 fix uninstall path for DESTDIR

---
 .evergreen/config.yml                 |  1 +
 .evergreen/install-uninstall-check.sh | 18 ++++++++++++++----
 CMakeLists.txt                        |  8 ++------
 build/generate-uninstall.sh           | 15 ++++++++++++---
 generate_uninstall/CMakeLists.txt     | 22 +++++++---------------
 5 files changed, 36 insertions(+), 28 deletions(-)

diff --git a/.evergreen/config.yml b/.evergreen/config.yml
index e85261c2b..d4be83c06 100644
--- a/.evergreen/config.yml
+++ b/.evergreen/config.yml
@@ -1657,6 +1657,7 @@ tasks:
             script: |
               set -o xtrace
               set -o errexit
+              DESTDIR="$(pwd)/dest" sh ./.evergreen/install-uninstall-check.sh
               BSON_ONLY=1 sh ./.evergreen/install-uninstall-check.sh
               sh ./.evergreen/install-uninstall-check.sh
 # }}}
diff --git a/.evergreen/install-uninstall-check.sh b/.evergreen/install-uninstall-check.sh
index a67c628ee..1be75b46b 100644
--- a/.evergreen/install-uninstall-check.sh
+++ b/.evergreen/install-uninstall-check.sh
@@ -19,10 +19,16 @@ fi
 
 if [ "$BSON_ONLY" ]; then
   BUILD_DIR=$(pwd)/build-dir-bson
-  INSTALL_DIR=$(pwd)/install-dir-bson
+  INSTALL_PREFIX=$(pwd)/install-dir-bson
 else
   BUILD_DIR=$(pwd)/build-dir-mongoc
-  INSTALL_DIR=$(pwd)/install-dir-mongoc
+  INSTALL_PREFIX=$(pwd)/install-dir-mongoc
+fi
+
+if [ "$DESTDIR" ]; then
+   INSTALL_DIR="${DESTDIR}/${INSTALL_PREFIX}"
+else
+   INSTALL_DIR=$INSTALL_PREFIX
 fi
 
 rm -rf $BUILD_DIR
@@ -41,9 +47,13 @@ else
 fi
 
 
-$CMAKE -DCMAKE_INSTALL_PREFIX=$INSTALL_DIR -DCMAKE_PREFIX_PATH=$INSTALL_DIR/lib/cmake $BSON_ONLY_OPTION .
+$CMAKE -DCMAKE_INSTALL_PREFIX=$INSTALL_PREFIX -DCMAKE_PREFIX_PATH=$INSTALL_DIR/lib/cmake $BSON_ONLY_OPTION .
 make
-make install
+if [ "$DESTDIR" ]; then
+   make DESTDIR=$DESTDIR install
+else
+   make install
+fi
 touch $INSTALL_DIR/lib/canary.txt
 
 ls -l $INSTALL_DIR/share/mongo-c-driver
diff --git a/CMakeLists.txt b/CMakeLists.txt
index f7a0dfe92..8c01ebd52 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -341,14 +341,10 @@ if (WIN32)
 else ()
    set (UNINSTALL_PROG "uninstall.sh")
 endif ()
-set (UNINSTALL_PROG_DIR "${CMAKE_INSTALL_FULL_DATADIR}/mongo-c-driver")
+set (UNINSTALL_PROG_DIR "${CMAKE_INSTALL_DATADIR}/mongo-c-driver")
 
 # Create uninstall program and associated uninstall target
 #
 # This needs to be last (after all other add_subdirectory calls) to ensure that
 # the generated uninstall program is complete and correct
-add_subdirectory (generate_uninstall)
-
-add_custom_target (uninstall
-   COMMAND "${UNINSTALL_PROG_DIR}/${UNINSTALL_PROG}"
-)
+add_subdirectory (generate_uninstall)
\ No newline at end of file
diff --git a/build/generate-uninstall.sh b/build/generate-uninstall.sh
index d80c4b60f..54d92d635 100755
--- a/build/generate-uninstall.sh
+++ b/build/generate-uninstall.sh
@@ -51,6 +51,15 @@ if [ "${prefix}" = "${prefix%/}" ]; then
    prefix="${prefix}/"
 fi
 
+# If a DESTDIR is specified, ensure it ends with a trailing slash.
+if [ "${DESTDIR}" ]; then
+   if [ "${DESTDIR}" = "${DESTDIR%/}" ]; then
+      # Trailing slash was omitted, so add it here
+      DESTDIR="${DESTDIR}/"
+   fi
+fi
+
+
 printf "#!/bin/sh\n"
 printf "# Mongo C Driver uninstall program, generated on %s\n" "$(date)"
 printf "\n"
@@ -69,7 +78,7 @@ printf "# See the License for the specific language governing permissions and\n"
 printf "# limitations under the License.\n"
 printf "\n"
 printf "save_pwd=\$(pwd)\n"
-printf "cd %s\n" "${prefix}"
+printf "cd %s\n" "${DESTDIR}${prefix}"
 printf "\n"
 
 dirs=
@@ -96,8 +105,8 @@ echo "${dirs}" | sort -ru | while IFS= read -r dir; do
 done
 
 printf "cd ..\n"
-printf "printf \"Removing top-level installation directory: \\\"%s\\\"\"\n" "${prefix}"
-printf "(rmdir \"%s\" 2>/dev/null && printf \"\\\n\") || printf \" ... not removed (probably not empty)\\\n\"\n" "${prefix}"
+printf "printf \"Removing top-level installation directory: \\\"%s\\\"\"\n" "${DESTDIR}${prefix}"
+printf "(rmdir \"%s\" 2>/dev/null && printf \"\\\n\") || printf \" ... not removed (probably not empty)\\\n\"\n" "${DESTDIR}${prefix}"
 printf "\n"
 printf "# Return to the directory from which the program was called\n"
 printf "cd \${save_pwd}\n"
diff --git a/generate_uninstall/CMakeLists.txt b/generate_uninstall/CMakeLists.txt
index 6eda5ee81..8903214e2 100644
--- a/generate_uninstall/CMakeLists.txt
+++ b/generate_uninstall/CMakeLists.txt
@@ -1,6 +1,7 @@
 # Fabricate our own copy of the install manifest, since the installation has not
 # generated the final version yet at this point
-install (CODE "file (MAKE_DIRECTORY \"${UNINSTALL_PROG_DIR}\")")
+
+set (UNINSTALL_PERMISSIONS OWNER_READ OWNER_WRITE OWNER_EXECUTE GROUP_READ GROUP_EXECUTE WORLD_READ WORLD_EXECUTE)
 
 if (WIN32)
    string (REPLACE "/" "\\\\" CMAKE_INSTALL_PREFIX_WIN32
@@ -23,13 +24,8 @@ if (WIN32)
          OUTPUT_FILE
             \"${CMAKE_CURRENT_BINARY_DIR}/${UNINSTALL_PROG}\"
       )
-      execute_process (
-         COMMAND
-            ${CMAKE_COMMAND} -E copy
-            \"${CMAKE_CURRENT_BINARY_DIR}/${UNINSTALL_PROG}\"
-            \"${UNINSTALL_PROG_DIR}/${UNINSTALL_PROG}\"
-      )
    ")
+   install (FILES "${CMAKE_CURRENT_BINARY_DIR}/${UNINSTALL_PROG}" DESTINATION "${UNINSTALL_PROG_DIR}" PERMISSIONS ${UNINSTALL_PERMISSIONS})
 else ()
    install (CODE "
       string(REPLACE \";\" \"\\n\" MONGOC_INSTALL_MANIFEST_CONTENT
@@ -45,14 +41,10 @@ else ()
          OUTPUT_FILE
             \"${CMAKE_CURRENT_BINARY_DIR}/${UNINSTALL_PROG}\"
       )
-      execute_process (
-         COMMAND
-            chmod a+x \"${CMAKE_CURRENT_BINARY_DIR}/${UNINSTALL_PROG}\"
-         COMMAND
-            cp
-            \"${CMAKE_CURRENT_BINARY_DIR}/${UNINSTALL_PROG}\"
-            \"${UNINSTALL_PROG_DIR}/${UNINSTALL_PROG}\"
-      )
    ")
+   install (FILES "${CMAKE_CURRENT_BINARY_DIR}/${UNINSTALL_PROG}" DESTINATION "${UNINSTALL_PROG_DIR}" PERMISSIONS ${UNINSTALL_PERMISSIONS})
 endif ()
 
+add_custom_target (uninstall
+   COMMAND "${CMAKE_CURRENT_BINARY_DIR}/${UNINSTALL_PROG}"
+)
